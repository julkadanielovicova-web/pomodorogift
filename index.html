<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Music Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1DB954;
            --secondary: #191414;
            --success: #10B981;
            --background: #0A0E27;
            --surface: #151B3D;
            --surface-light: #1E2749;
            --text: #E2E8F0;
            --text-dim: #94A3B8;
            --accent: #1DB954;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(29, 185, 84, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(29, 185, 84, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(29, 185, 84, 0.06) 0%, transparent 50%);
            animation: drift 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes drift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(2%, 3%) rotate(1deg); }
            66% { transform: translate(-2%, 2%) rotate(-1deg); }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Syne', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #1DB954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .spotify-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        .stats-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            animation: fadeIn 1s ease-out 0.3s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .stat {
            background: var(--surface);
            border: 2px solid var(--surface-light);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Syne', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-top: 0.25rem;
        }

        .timer-card {
            background: var(--surface);
            border: 2px solid var(--surface-light);
            border-radius: 24px;
            padding: 3rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            animation: scaleIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .timer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1DB954, #1ed760);
            transform: scaleX(0);
            transform-origin: left;
        }

        .timer-card.working::before {
            animation: progressBar 1500s linear forwards;
        }

        @keyframes progressBar {
            to { transform: scaleX(1); }
        }

        .timer-display {
            font-family: 'Syne', sans-serif;
            font-size: 6rem;
            font-weight: 800;
            text-align: center;
            margin: 2rem 0;
            color: var(--text);
            text-shadow: 0 0 40px rgba(29, 185, 84, 0.3);
            letter-spacing: -0.02em;
        }

        .timer-status {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--surface);
            transform: translateY(-2px);
        }

        .connect-section {
            background: var(--surface);
            border: 2px solid var(--surface-light);
            border-radius: 24px;
            padding: 3rem;
            text-align: center;
            animation: scaleIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.4s both;
        }

        .connect-section h2 {
            font-family: 'Syne', sans-serif;
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .connect-section p {
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .help-text {
            background: var(--surface-light);
            border-left: 4px solid #FBBF24;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem auto;
            max-width: 700px;
            text-align: left;
            font-size: 0.95rem;
            line-height: 1.8;
        }

        .help-text strong {
            color: var(--primary);
        }

        .help-text ol {
            margin: 1rem 0 1rem 1.5rem;
        }

        .help-text li {
            margin-bottom: 0.5rem;
        }

        .help-text code {
            background: var(--background);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .game-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
            animation: modalFadeIn 0.4s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .game-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .game-content {
            background: var(--surface);
            border: 2px solid var(--surface-light);
            border-radius: 24px;
            padding: 3rem;
            max-width: 600px;
            width: 100%;
            animation: modalSlideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-title {
            font-family: 'Syne', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #1DB954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .game-subtitle {
            text-align: center;
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .audio-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .audio-btn {
            padding: 1rem;
            background: var(--surface-light);
            border: 2px solid var(--surface-light);
            border-radius: 12px;
            color: var(--text);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .audio-btn:hover:not(:disabled) {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .audio-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .audio-btn.played {
            background: var(--success);
            border-color: var(--success);
        }

        .skip-btn {
            width: 100%;
            padding: 1rem;
            background: var(--surface-light);
            border: 2px solid var(--surface-light);
            color: var(--text);
            font-weight: 600;
        }

        .skip-btn:hover {
            background: var(--surface);
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--surface-light);
            border: 2px solid var(--surface-light);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--background);
        }

        .search-results {
            background: var(--background);
            border: 2px solid var(--surface-light);
            border-radius: 12px;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result {
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--surface-light);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .search-result:hover {
            background: var(--surface-light);
        }

        .result-album-art {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
        }

        .result-info {
            flex: 1;
        }

        .result-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .result-artist {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .guesses {
            margin-bottom: 2rem;
        }

        .guess-item {
            background: var(--surface-light);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .guess-item.correct {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border: 2px solid var(--success);
        }

        .guess-item.incorrect {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            border: 2px solid #EF4444;
        }

        .guess-item.skipped {
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.2), rgba(148, 163, 184, 0.1));
            border: 2px solid var(--text-dim);
        }

        .guess-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .correct .guess-badge {
            background: var(--success);
            color: white;
        }

        .incorrect .guess-badge {
            background: #EF4444;
            color: white;
        }

        .skipped .guess-badge {
            background: var(--text-dim);
            color: white;
        }

        .result-message {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            padding: 2rem;
            border-radius: 16px;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .result-message.won {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border: 2px solid var(--success);
            color: var(--success);
        }

        .result-message.lost {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            border: 2px solid #EF4444;
            color: #EF4444;
        }

        .song-reveal {
            text-align: center;
            padding: 2rem;
            background: var(--surface-light);
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .song-reveal img {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .song-reveal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .song-reveal-artist {
            font-size: 1.1rem;
            color: var(--text-dim);
        }

        .attempts-display {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .timer-display {
                font-size: 4rem;
            }

            .stats-bar {
                flex-direction: column;
            }

            .audio-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçÖ Pomodoro Music Challenge</h1>
            <p class="subtitle">Work focused. Play music. Every 4 rounds, guess the song!</p>
            <div class="spotify-badge">
                <span>üéµ</span>
                <span>Powered by Spotify</span>
            </div>
        </header>

        <!-- Connect Section -->
        <div class="connect-section" id="connectSection">
            <h2>üéµ Let's Get Started!</h2>
            <p>To enable the music guessing game, you need to set up Spotify authentication once.</p>
            
            <div class="help-text">
                <strong>‚ö†Ô∏è ONE-TIME SETUP REQUIRED:</strong>
                <p>This app needs to be hosted online to work properly. Here's the easiest way:</p>
                <ol>
                    <li>Upload this file to <strong>GitHub Pages</strong>, <strong>Netlify</strong>, or any web hosting</li>
                    <li>Once hosted, you'll get a URL like: <code>https://yoursite.com/pomodoro.html</code></li>
                    <li>Add that URL as a Redirect URI in your <a href="https://developer.spotify.com/dashboard" target="_blank" style="color: var(--primary);">Spotify Developer Dashboard</a></li>
                    <li>Update the <code>CLIENT_ID</code> in this file with your Spotify Client ID</li>
                    <li>Share the link with anyone - they just click and play!</li>
                </ol>
                <p style="margin-top: 1rem;"><strong>üí° Need help hosting?</strong> The easiest free options are:</p>
                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li><strong>Netlify Drop:</strong> Just drag & drop at <a href="https://app.netlify.com/drop" target="_blank" style="color: var(--primary);">app.netlify.com/drop</a></li>
                    <li><strong>GitHub Pages:</strong> Upload to a GitHub repo and enable Pages in settings</li>
                </ul>
            </div>

            <button class="btn-primary" onclick="connectSpotify()">
                <span>üéß Connect Spotify & Start</span>
            </button>
        </div>

        <!-- Main App (hidden until authenticated) -->
        <div id="mainApp" style="display: none;">
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-label">Round</div>
                    <div class="stat-value" id="roundDisplay">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" id="completedDisplay">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Songs Won</div>
                    <div class="stat-value" id="songsWonDisplay">0</div>
                </div>
            </div>

            <div class="timer-card" id="timerCard">
                <div class="timer-status" id="timerStatus">Ready to Focus</div>
                <div class="timer-display" id="timerDisplay">25:00</div>
                <div class="controls">
                    <button class="btn-primary" id="startBtn" onclick="startTimer()">
                        <span>Start Session</span>
                    </button>
                    <button class="btn-secondary" id="resetBtn" onclick="resetTimer()">
                        <span>Reset</span>
                    </button>
                    <button class="btn-secondary" onclick="testGame()">
                        <span>üéÆ Test Game</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div class="game-modal" id="gameModal">
        <div class="game-content">
            <h2 class="game-title">üéµ Guess That Song!</h2>
            <p class="game-subtitle">Listen carefully and guess the song from your playlist!</p>
            
            <div id="gameLoading" class="loading">
                Loading song from your playlist...
            </div>

            <div id="gameArea" style="display: none;">
                <div class="attempts-display" id="attemptsDisplay">
                    Attempts remaining: <strong>6</strong>
                </div>

                <div class="audio-controls">
                    <div class="audio-buttons">
                        <button class="audio-btn" onclick="playAudio(0, 1)">‚ñ∂ 1s</button>
                        <button class="audio-btn" onclick="playAudio(1, 2)" disabled>‚ñ∂ 2s</button>
                        <button class="audio-btn" onclick="playAudio(2, 4)" disabled>‚ñ∂ 4s</button>
                        <button class="audio-btn" onclick="playAudio(3, 8)" disabled>‚ñ∂ 8s</button>
                        <button class="audio-btn" onclick="playAudio(4, 16)" disabled>‚ñ∂ 16s</button>
                        <button class="audio-btn" onclick="playAudio(5, 30)" disabled>‚ñ∂ Full</button>
                    </div>
                    <button class="skip-btn" onclick="skipGuess()">
                        <span>‚è≠ Skip (+unlock next duration)</span>
                    </button>
                </div>

                <div class="search-box">
                    <input 
                        type="text" 
                        class="search-input" 
                        id="searchInput" 
                        placeholder="Search for the song..."
                        oninput="searchSongs(this.value)"
                    >
                    <div class="search-results" id="searchResults" style="display: none;"></div>
                </div>

                <div class="guesses" id="guesses"></div>

                <div id="resultArea" style="display: none;">
                    <div class="result-message" id="resultMessage"></div>
                    <div class="song-reveal">
                        <img id="correctAlbumArt" src="" alt="Album Art">
                        <div class="song-reveal-title" id="correctTitle"></div>
                        <div class="song-reveal-artist" id="correctArtist"></div>
                    </div>
                    <button class="btn-primary" onclick="closeGame()" style="width: 100%;">
                        <span>Back to Pomodoro</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        // Configuration
        const CLIENT_ID = '6cc1744c4ae045bbb6b45cfe77d2d8f4';
        const PLAYLIST_ID = '2MwbB1F9RRYtWzvM9rD1Bz';
        const REDIRECT_URI = window.location.href.split('?')[0].split('#')[0];
        
        let accessToken = null;
        let playlistTracks = [];

        // Pomodoro Timer State
        let timerInterval = null;
        let timeRemaining = 25 * 60;
        let isWorking = true;
        let currentRound = 1;
        let completedRounds = 0;
        let songsWon = 0;
        let isRunning = false;

        // Game State
        let currentSong = null;
        let guessCount = 0;
        let maxGuesses = 6;
        let currentPlayIndex = 0;
        let searchTimeout = null;

        window.addEventListener('load', () => {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                if (accessToken) {
                    window.location.hash = '';
                    initializeApp();
                }
            } else if (localStorage.getItem('spotify_access_token')) {
                accessToken = localStorage.getItem('spotify_access_token');
                initializeApp();
            }
        });

        function connectSpotify() {
            const scopes = 'playlist-read-private playlist-read-collaborative';
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scopes)}`;
            window.location.href = authUrl;
        }

        async function initializeApp() {
            localStorage.setItem('spotify_access_token', accessToken);
            document.getElementById('connectSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            await loadPlaylistTracks();
            updateDisplay();
        }

        async function loadPlaylistTracks() {
            try {
                const response = await fetch(`https://api.spotify.com/v1/playlists/${PLAYLIST_ID}/tracks`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load playlist');
                }

                const data = await response.json();
                playlistTracks = data.items
                    .filter(item => item.track && item.track.preview_url)
                    .map(item => item.track);

                console.log(`Loaded ${playlistTracks.length} tracks with previews from playlist`);
            } catch (error) {
                console.error('Error loading playlist:', error);
                alert('Error loading playlist. Please try reconnecting.');
                localStorage.removeItem('spotify_access_token');
                location.reload();
            }
        }

        function updateDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerStatus').textContent = 
                isWorking ? 'Focus Time üéØ' : 'Break Time ‚òï';
            
            document.getElementById('roundDisplay').textContent = currentRound;
            document.getElementById('completedDisplay').textContent = completedRounds;
            document.getElementById('songsWonDisplay').textContent = songsWon;
        }

        function startTimer() {
            if (isRunning) {
                pauseTimer();
                return;
            }

            isRunning = true;
            document.getElementById('startBtn').innerHTML = '<span>Pause</span>';
            document.getElementById('timerCard').classList.add('working');

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateDisplay();

                if (timeRemaining <= 0) {
                    timerComplete();
                }
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').innerHTML = '<span>Resume</span>';
            document.getElementById('timerCard').classList.remove('working');
        }

        function resetTimer() {
            pauseTimer();
            timeRemaining = isWorking ? 25 * 60 : 5 * 60;
            document.getElementById('startBtn').innerHTML = '<span>Start Session</span>';
            updateDisplay();
        }

        function timerComplete() {
            pauseTimer();
            
            if (isWorking) {
                completedRounds++;
                
                if (completedRounds % 4 === 0) {
                    showMusicGame();
                } else {
                    isWorking = false;
                    timeRemaining = 5 * 60;
                    currentRound++;
                    alert('üéâ Great work! Time for a 5-minute break!');
                }
            } else {
                isWorking = true;
                timeRemaining = 25 * 60;
                alert('‚ú® Break over! Ready for another focus session?');
            }
            
            document.getElementById('startBtn').innerHTML = '<span>Start Session</span>';
            updateDisplay();
        }

        function testGame() {
            showMusicGame();
        }

        async function showMusicGame() {
            document.getElementById('gameModal').classList.add('active');
            document.getElementById('gameLoading').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            
            await loadRandomSong();
            
            document.getElementById('gameLoading').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            resetGameState();
        }

        function resetGameState() {
            guessCount = 0;
            currentPlayIndex = 0;
            document.getElementById('guesses').innerHTML = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('resultArea').style.display = 'none';
            updateAttemptsDisplay();
            
            const buttons = document.querySelectorAll('.audio-btn');
            buttons.forEach((btn, idx) => {
                btn.disabled = idx !== 0;
                btn.classList.remove('played');
            });
        }

        function updateAttemptsDisplay() {
            const remaining = maxGuesses - guessCount;
            document.getElementById('attemptsDisplay').innerHTML = 
                `Attempts remaining: <strong>${remaining}</strong>`;
        }

        async function loadRandomSong() {
            if (playlistTracks.length === 0) {
                alert('No songs with previews found in your playlist!');
                return;
            }

            const randomIndex = Math.floor(Math.random() * playlistTracks.length);
            currentSong = playlistTracks[randomIndex];
            
            console.log('Loaded song:', currentSong.name, 'by', currentSong.artists[0].name);
        }

        function playAudio(index, duration) {
            if (!currentSong || !currentSong.preview_url) {
                alert('No audio preview available for this song!');
                return;
            }

            const audio = document.getElementById('audioPlayer');
            audio.src = currentSong.preview_url;
            audio.currentTime = 0;
            audio.play();

            setTimeout(() => {
                audio.pause();
            }, duration * 1000);

            const buttons = document.querySelectorAll('.audio-btn');
            buttons[index].classList.add('played');
            
            if (index < buttons.length - 1) {
                buttons[index + 1].disabled = false;
            }
            currentPlayIndex = index + 1;
        }

        function skipGuess() {
            if (guessCount >= maxGuesses) return;

            guessCount++;
            
            const guessesDiv = document.getElementById('guesses');
            const guessItem = document.createElement('div');
            guessItem.className = 'guess-item skipped';
            guessItem.innerHTML = `
                <div>
                    <div class="result-title">Skipped</div>
                    <div class="result-artist">No guess made</div>
                </div>
                <span class="guess-badge">Skipped</span>
            `;
            guessesDiv.appendChild(guessItem);

            updateAttemptsDisplay();

            const buttons = document.querySelectorAll('.audio-btn');
            if (currentPlayIndex < buttons.length) {
                buttons[currentPlayIndex].disabled = false;
            }

            if (guessCount >= maxGuesses) {
                showResult(false);
            }
        }

        async function searchSongs(query) {
            clearTimeout(searchTimeout);
            
            if (!query || query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(
                        `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        }
                    );

                    const data = await response.json();
                    displaySearchResults(data.tracks.items);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.style.display = 'none';
                return;
            }

            resultsDiv.innerHTML = results.map(track => `
                <div class="search-result" onclick='makeGuess(${JSON.stringify({
                    id: track.id,
                    name: track.name,
                    artist: track.artists[0].name,
                    image: track.album.images[2]?.url
                })})'>
                    <img src="${track.album.images[2]?.url || ''}" alt="" class="result-album-art">
                    <div class="result-info">
                        <div class="result-title">${track.name}</div>
                        <div class="result-artist">${track.artists[0].name}</div>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
        }

        function makeGuess(track) {
            if (guessCount >= maxGuesses) return;

            guessCount++;
            const isCorrect = track.id === currentSong.id;

            const guessesDiv = document.getElementById('guesses');
            const guessItem = document.createElement('div');
            guessItem.className = `guess-item ${isCorrect ? 'correct' : 'incorrect'}`;
            guessItem.innerHTML = `
                <div>
                    <div class="result-title">${track.name}</div>
                    <div class="result-artist">${track.artist}</div>
                </div>
                <span class="guess-badge">${isCorrect ? '‚úì Correct' : '‚úó Wrong'}</span>
            `;
            guessesDiv.appendChild(guessItem);

            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            updateAttemptsDisplay();

            if (isCorrect) {
                showResult(true);
            } else if (guessCount >= maxGuesses) {
                showResult(false);
            } else {
                const buttons = document.querySelectorAll('.audio-btn');
                if (currentPlayIndex < buttons.length) {
                    buttons[currentPlayIndex].disabled = false;
                }
            }
        }

        function showResult(won) {
            document.getElementById('gameArea').querySelector('.audio-controls').style.display = 'none';
            document.getElementById('gameArea').querySelector('.search-box').style.display = 'none';
            document.getElementById('resultArea').style.display = 'block';

            const resultMessage = document.getElementById('resultMessage');
            resultMessage.className = `result-message ${won ? 'won' : 'lost'}`;
            resultMessage.textContent = won 
                ? `üéâ Incredible! You got it in ${guessCount} ${guessCount === 1 ? 'guess' : 'guesses'}!` 
                : `üòî Nice try! The answer was:`;

            document.getElementById('correctAlbumArt').src = currentSong.album.images[1]?.url || currentSong.album.images[0]?.url;
            document.getElementById('correctTitle').textContent = currentSong.name;
            document.getElementById('correctArtist').textContent = `by ${currentSong.artists[0].name}`;

            if (won) {
                songsWon++;
                updateDisplay();
            }

            document.getElementById('audioPlayer').pause();
        }

        function closeGame() {
            document.getElementById('gameModal').classList.remove('active');
            
            document.getElementById('gameArea').querySelector('.audio-controls').style.display = 'flex';
            document.getElementById('gameArea').querySelector('.search-box').style.display = 'block';
            
            isWorking = false;
            timeRemaining = 5 * 60;
            currentRound++;
            updateDisplay();
        }
    </script>
</body>
</html>
